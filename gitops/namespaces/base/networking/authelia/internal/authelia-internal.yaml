---
apiVersion: helm.toolkit.fluxcd.io/v2beta1
kind: HelmRelease
metadata:
  name: authelia-internal
  namespace: networking
spec:
  interval: 5m
  chart:
    spec:
      # renovate: registryUrl=https://charts.authelia.com
      chart: authelia
      version: 0.3.15
      sourceRef:
        kind: HelmRepository
        name: authelia-charts
        namespace: flux-system
      interval: 5m
  dependsOn:
    - name: traefik
      namespace: networking
  values:
    image:
      registry: ghcr.io
    secret:
      existingSecret: "authelia-secrets"
    domain: rabbito.tech
    configMap:
      storage:
        postgres:
          enabled: true
          host: acid-authelia-cluster-pooler
          database: authelia_internal
          username: postgres
      authentication_backend:
        ldap:
          enabled: true
          implementation: custom
          url: ldap://den.rabbito.tech:389
          tls:
            skip_verify: true
          base_dn: dc=rabbito,dc=tech
          users_filter: "(&({username_attribute}={input})(objectClass=person))"
          username_attribute: "uid"
          additional_users_dn: cn=users,cn=accounts
          additional_groups_dn: cn=groups,cn=accounts
          groups_filter: "(&(member=uid={input},cn=users,cn=accounts,dc=DOMAIN,dc=TLD)(objectclass=groupofnames))"
          group_name_attribute: "cn"
          mail_attribute: "mail"
          display_name_attribute: "givenName"
          user: uid=system,cn=sysaccounts,cn=etc,dc=rabbito,dc=tech
      session:
        redis:
          enabled: false
      access_control:
        default_policy: one_factor
