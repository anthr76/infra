---
apiVersion: metal.sidero.dev/v1alpha1
kind: ServerClass
metadata:
  name: masters
  namespace: default
spec:
  configPatches:
    - op: add
      path: /machine/install/extraKernelArgs
      value:
        - initcall_blacklist=aoe_init
    - op: replace
      path: /cluster/apiServer/image
      value: k8s.gcr.io/kube-apiserver:v1.23.2
    - op: replace
      path: /cluster/controllerManager/image
      value: k8s.gcr.io/kube-controller-manager:v1.23.2
    - op: replace
      path: /cluster/scheduler/image
      value: k8s.gcr.io/kube-scheduler:v1.23.2
    - op: replace
      path: /machine/kubelet/image
      value: ghcr.io/talos-systems/kubelet:v1.23.2
    - op: replace
      path: /cluster/proxy/disabled
      value: true
    - op: add
      path: /cluster/coreDNS
      value:
        image: docker.io/coredns/coredns:1.9.0
    - op: replace
      path: /machine/install/disk
      value: /dev/sda
    - op: replace
      path: /persist
      value: false
    - op: add
      path: /machine/kubelet/extraArgs
      value:
        rotate-server-certificates: true
        feature-gates: MixedProtocolLBService=true,ReadWriteOncePod=true,EphemeralContainers=true
    - op: add
      path: /machine/time
      value:
        disabled: false
        servers:
          - time.cloudflare.com
    - op: add
      path: /machine/certSANs
      value:
        - cluster-0.scr1.rabbito.tech
    # Please let me know a better way to do this...
    - op: add
      path: /cluster/controllerManager/extraArgs
      value:
        bind-address: 0.0.0.0
        node-cidr-mask-size-ipv4: 24
        node-cidr-mask-size-ipv6: 64
    - op: add
      path: /cluster/scheduler/extraArgs
      value:
        bind-address: 0.0.0.0
    - op: add
      path: /cluster/etcd/extraArgs
      value:
        listen-metrics-urls: http://0.0.0.0:2381
    - op: replace
      path: /cluster/network/cni
      value:
        name: "custom"
        urls:
          - "https://raw.githubusercontent.com/anthr76/infra/main/clusters/scr1/intergrations/cilium-quick-install/cluster_0_quick_install.yaml"
    - op: replace
      path: /cluster/network/podSubnets
      value:
        - 10.244.0.0/16
        - fddf:f7bc:9670::/48
    - op: replace
      path: /cluster/network/serviceSubnets
      value:
        - 10.96.0.0/12
        - 2001:559:1104:fdb::/112
  selector:
    matchLabels:
      master: "true"
