---
apiVersion: helm.toolkit.fluxcd.io/v2beta1
kind: HelmRelease
metadata:
  name: lnd
  namespace: crypto
  labels:
    component.kutara.io/part-of: standard-helm-release
spec:
  interval: 30m
  chart:
    spec:
      chart: lnd
      version: 0.3.10
      sourceRef:
        kind: HelmRepository
        name: galoymoney
        namespace: flux-system
  values:
    initContainers:
      init-db:
        image: ghcr.io/onedr0p/postgres-initdb:14.6@sha256:0ceb9386a7da7f646fc2c971dcb34dfed3bf44ff0ee8e29c81a2a084a7b1b88c
        env:
          - name: POSTGRES_HOST
            value: postgres-rw.database.svc.cluster.local
          - name: POSTGRES_DB
            value: lnd
          - name: POSTGRES_SUPER_PASS
            valueFrom:
              secretKeyRef:
                name: postgres-superuser
                key: password
          - name: POSTGRES_USER
            value: lnd
          - name: POSTGRES_PASS
            valueFrom:
              secretKeyRef:
                name: lnd-es
                key: postgresql-password
    lndGeneralConfig:
      - restlisten=0.0.0.0:8080
      - rpclisten=0.0.0.0:10009
      - listen=0.0.0.0:9735
      - prometheus.listen=0.0.0.0:9092
      - bitcoin.active=true
      - bitcoin.node=bitcoind
      - bitcoind.rpcuser=rpcuser
      - bitcoind.zmqpubrawblock=tcp://bitcoind:28332
      - bitcoind.zmqpubrawtx=tcp://bitcoind:28333
      - bitcoind.rpchost=bitcoind:8332
      - tlsextradomain=lnd
      - accept-keysend=1
      - allow-circular-route=1
      - stagger-initial-reconnect=1
      - protocol.wumbo-channels=1
      - maxchansize=500000000
      - bitcoin.timelockdelta=60
      - default-remote-max-htlcs=50
      - debuglevel=info
      - prometheus.enable=1
      - gc-canceled-invoices-on-the-fly=true
      - gc-canceled-invoices-on-startup=true
      - tor.active=true
      - tor.v3=true
      - tor.skip-proxy-for-clearnet-targets=true
    loop:
      persistence:
        storageClass: fast-ceph-block
    persistence:
      storageClass: fast-ceph-block
    postgresql:
      auth:
        existingSecret: lnd-es
    lnd:
      db:
        config:
          secret: lnd-es
