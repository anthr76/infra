---
apiVersion: helm.toolkit.fluxcd.io/v2beta1
kind: HelmRelease
metadata:
  name: lnd
  namespace: crypto
  labels:
    component.kutara.io/part-of: standard-helm-release
spec:
  dependsOn:
    - name: bitcoind
  interval: 10m
  upgrade:
    disableWait: true
    remediation:
      remediateLastFailure: false
  chart:
    spec:
      chart: lnd
      version: 0.3.10
      sourceRef:
        kind: HelmRepository
        name: galoymoney
        namespace: flux-system
  values:
    initContainers:
      init-db:
        image: ghcr.io/onedr0p/postgres-initdb:14.6@sha256:0ceb9386a7da7f646fc2c971dcb34dfed3bf44ff0ee8e29c81a2a084a7b1b88c
        env:
          - name: POSTGRES_HOST
            value: postgres-rw.database.svc.cluster.local
          - name: POSTGRES_DB
            value: lnd
          - name: POSTGRES_SUPER_PASS
            valueFrom:
              secretKeyRef:
                name: postgres-superuser
                key: password
          - name: POSTGRES_USER
            value: lnd
          - name: POSTGRES_PASS
            valueFrom:
              secretKeyRef:
                name: lnd-es
                key: postgresql-password
    configmap:
      customValues:
        - bitcoind.rpchost=bitcoind:8332
        - tlsextradomain=lnd.scr1.rabbito.tech
        - tlsextradomain=77n5xifxcsdgmwya5d6nhid7twuanoszd727nko6jcepbltqorw2wfqd.onion
        - alias=Kutara
        - allow-circular-route=true
    loop:
      persistence:
        storageClass: fast-ceph-block
    persistence:
      storageClass: fast-ceph-block
    postgresql:
      auth:
        existingSecret: lnd-es
    lnd:
      db:
        config:
          secret: lnd-es
