---
apiVersion: batch/v1
kind: CronJob
metadata:
  name: ostree-fetch
  namespace: infra
spec:
  schedule: "0 17 * * *"
  jobTemplate:
    spec:
      template:
        spec:
          containers:
            - name: ostree-fetch
              image: ghcr.io/anthr76/kutara-ostree:latest@sha256:c28c8a8dcbb40cf75444942ecc2928ee902d8c31095253ee7c276ec8e1ba9d5f
              imagePullPolicy: IfNotPresent
              command:
                - /bin/bash
                - -c
                - |-
                  REMOTE="$(skopeo inspect docker://registry.gitlab.com/fedora/sigs/sway/ostree-config:rawhide | jq '.Labels."ostree.commit"' | sed 's/"//g')"
                  LOCAL="$(ostree log --repo /data fedora/rawhide/x86_64/sway | head -n 1 | grep commit | sed 's/commit //g' )"
                  echo remote: $REMOTE
                  echo local: $LOCAL
                  if [ "$LOCAL" = "$REMOTE" ]; then
                    echo "rawhide sway refs up-to-date"
                  else
                    ostree init --mode=bare --repo=./repo
                    ostree container unencapsulate ostree-unverified-image:docker://registry.gitlab.com/fedora/sigs/sway/ostree-config:rawhide --repo=./repo --write-ref fedora/rawhide/x86_64/sway
                    ostree pull-local --repo=/data ./repo
                  fi
              volumeMounts:
                - mountPath: /data
                  name: data
              securityContext:
                runAsUser: 0
                privileged: true
          restartPolicy: OnFailure
          volumes:
            - name: data
              persistentVolumeClaim:
                claimName: ostree-repo
