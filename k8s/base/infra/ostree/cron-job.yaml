---
apiVersion: batch/v1
kind: CronJob
metadata:
  name: ostree-fetch-rawhide
  namespace: infra
  labels:
    app.kubernetes.io/instance: ostree-fetch-rawhide
    app.kubernetes.io/name: ostree-fetch-rawhide
spec:
  successfulJobsHistoryLimit: 3
  schedule: "0 17 * * *"
  jobTemplate:
    spec:
      template:
        spec:
          containers:
            - name: ostree-fetch
              image: ghcr.io/anthr76/kutara-ostree:latest@sha256:04d3429aaca5a67e81f8f7e26ed7aa43a3d092dda61d8513e3e6416a155b34b9
              imagePullPolicy: IfNotPresent
              command:
                - /bin/bash
                - -c
                - |-
                  REMOTE="$(skopeo inspect docker://registry.gitlab.com/fedora/sigs/sway/ostree-config:rawhide | jq '.Labels."ostree.commit"' | sed 's/"//g')"
                  LOCAL="$(ostree log --repo /data fedora/rawhide/x86_64/sway | head -n 1 | grep commit | sed 's/commit //g' )"
                  echo remote: $REMOTE
                  echo local: $LOCAL
                  if [ "$LOCAL" = "$REMOTE" ]; then
                    echo "rawhide sway refs up-to-date"
                  else
                    ostree init --mode=bare --repo=./repo
                    ostree container unencapsulate ostree-unverified-image:docker://registry.gitlab.com/fedora/sigs/sway/ostree-config:rawhide --repo=./repo --write-ref fedora/rawhide/x86_64/sway
                    ostree pull-local --repo=/data ./repo
                  fi
              volumeMounts:
                - mountPath: /data
                  name: data
              securityContext:
                runAsUser: 0
                privileged: true
          restartPolicy: OnFailure
          volumes:
            - name: data
              persistentVolumeClaim:
                claimName: ostree-repo
---
apiVersion: batch/v1
kind: CronJob
metadata:
  name: ostree-fetch-f36
  namespace: infra
  labels:
    app.kubernetes.io/instance: ostree-fetch-f36
    app.kubernetes.io/name: ostree-fetch-f36
spec:
  successfulJobsHistoryLimit: 3
  schedule: "0 17 * * *"
  jobTemplate:
    spec:
      template:
        spec:
          containers:
            - name: ostree-fetch
              image: ghcr.io/anthr76/kutara-ostree:latest@sha256:04d3429aaca5a67e81f8f7e26ed7aa43a3d092dda61d8513e3e6416a155b34b9
              imagePullPolicy: IfNotPresent
              command:
                - /bin/bash
                - -c
                - |-
                  REMOTE="$(skopeo inspect docker://registry.gitlab.com/fedora/sigs/sway/ostree-config:36 | jq '.Labels."ostree.commit"' | sed 's/"//g')"
                  LOCAL="$(ostree log --repo /data fedora/36/x86_64/sway | head -n 1 | grep commit | sed 's/commit //g' )"
                  echo remote: $REMOTE
                  echo local: $LOCAL
                  if [ "$LOCAL" = "$REMOTE" ]; then
                    echo "f36 sway refs up-to-date"
                  else
                    ostree init --mode=bare --repo=./repo
                    ostree container unencapsulate ostree-unverified-image:docker://registry.gitlab.com/fedora/sigs/sway/ostree-config:36 --repo=./repo --write-ref fedora/36/x86_64/sway
                    ostree pull-local --repo=/data ./repo
                  fi
              volumeMounts:
                - mountPath: /data
                  name: data
              securityContext:
                runAsUser: 0
                privileged: true
          restartPolicy: OnFailure
          volumes:
            - name: data
              persistentVolumeClaim:
                claimName: ostree-repo
