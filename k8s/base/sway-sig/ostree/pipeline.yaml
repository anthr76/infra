---
apiVersion: tekton.dev/v1beta1
kind: Pipeline
metadata:
  name: ostree-to-prod
  namespace: sway-sig
spec:
  params:
    - name: GITLAB_HOST
      description: The GitLab instance to report the status to
      default: "gitlab.com"
    - name: REPO_PATH_ONLY
      type: string
      description: GitLab group & repo name only (e.g. jonashackt/microservice-api-spring-boot)
    - name: TEKTON_DASHBOARD_HOST
      description: The Tekton Dashboard URL for the status reports in GitLab
      default: "https://tekton.kutara.io/dashboard/"
    - name: SOURCE_REVISION
      description: The branch, tag or SHA to checkout.
      default: ""
    - name: FEDORA_VERSION_BRANCH
      description: The version of fedora to promote.
  description: promotes ostree containers to production repo.
  workspaces:
  - name: prod
  - name: scratch-repo
  tasks:
  - name: report-pipeline-start-to-gitlab
    taskRef:
      name: gitlab-set-status
    params:
      - name: "STATE"
        value: "running"
      - name: "GITLAB_HOST_URL"
        value: "$(params.GITLAB_HOST)"
      - name: "REPO_FULL_NAME"
        value: "$(params.REPO_PATH_ONLY)"
      - name: "GITLAB_TOKEN_SECRET_NAME"
        value: "gitlab-api"
      - name: "GITLAB_TOKEN_SECRET_KEY"
        value: "pat"
      - name: "TARGET_URL"
        value: "$(params.TEKTON_DASHBOARD_HOST)/#/namespaces/sway-sig/pipelineruns/$(context.pipelineRun.name)"
      - name: "CONTEXT"
        value: "tekton-pipeline"
      - name: "DESCRIPTION"
        value: "Promoting ostree builds in Tekton"
      - name: "SHA"
        value: "$(params.SOURCE_REVISION)"
  - name: ostree-promote-rawhide
    taskRef:
      name: ostree-promote
    when:
      - input: $(params.FEDORA_VERSION_BRANCH)
        operator: in
        values:
          - rawhide-sway-spin
    params:
      - name: "FEDORA_VERSION"
        value: "rawhide"
    workspaces:
    - name: prod
      workspace: prod
    - name: scratch-repo
      workspace: scratch-repo
  - name: ostree-promote-f37
    taskRef:
      name: ostree-promote
    when:
      - input: $(params.FEDORA_VERSION_BRANCH)
        operator: in
        values:
          - f37-sway-spin
    params:
      - name: "FEDORA_VERSION"
        value: "37"
    workspaces:
    - name: prod
      workspace: prod
    - name: scratch-repo
      workspace: scratch-repo
  - name: ostree-promote-f36
    taskRef:
      name: ostree-promote
    when:
      - input: $(params.FEDORA_VERSION_BRANCH)
        operator: in
        values:
          - f36-sway-spin
    params:
      - name: "FEDORA_VERSION"
        value: "36"
    workspaces:
    - name: prod
      workspace: prod
    - name: scratch-repo
      workspace: scratch-repo
  finally:
    - name: report-pipeline-failed-to-gitlab
      when:
        - input: $(tasks.status)
          operator: in
          values: [ "Failed", "None" ]
      taskRef:
        name: "gitlab-set-status"
      params:
        - name: "STATE"
          value: "failed"
        - name: "GITLAB_HOST_URL"
          value: "$(params.GITLAB_HOST)"
        - name: "REPO_FULL_NAME"
          value: "$(params.REPO_PATH_ONLY)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: "gitlab-api"
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: "pat"
        - name: "TARGET_URL"
          value: "$(params.TEKTON_DASHBOARD_HOST)/#/namespaces/sway-sig/pipelineruns/$(context.pipelineRun.name)"
        - name: "CONTEXT"
          value: "tekton-pipeline"
        - name: "DESCRIPTION"
          value: "An error occurred promoting ostree in Tekton"
        - name: "SHA"
          value: "$(params.SOURCE_REVISION)"
    - name: report-pipeline-success-to-gitlab
      when:
        - input: $(tasks.status)
          operator: in
          values: [ "Succeeded", "Completed" ]
      taskRef:
        name: "gitlab-set-status"
      params:
        - name: "STATE"
          value: "success"
        - name: "GITLAB_HOST_URL"
          value: "$(params.GITLAB_HOST)"
        - name: "REPO_FULL_NAME"
          value: "$(params.REPO_PATH_ONLY)"
        - name: "GITLAB_TOKEN_SECRET_NAME"
          value: "gitlab-api"
        - name: "GITLAB_TOKEN_SECRET_KEY"
          value: "pat"
        - name: "TARGET_URL"
          value: "$(params.TEKTON_DASHBOARD_HOST)/#/namespaces/sway-sig/pipelineruns/$(context.pipelineRun.name)"
        - name: "CONTEXT"
          value: "tekton-pipeline"
        - name: "DESCRIPTION"
          value: "ostree repos have been pushed to https://sway-sig.kutara.io/ostree/"
        - name: "SHA"
          value: "$(params.SOURCE_REVISION)"
