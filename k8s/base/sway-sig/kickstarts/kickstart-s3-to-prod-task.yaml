---
apiVersion: tekton.dev/v1beta1
kind: Task
metadata:
  name: kickstart-s3-to-prod
  namespace: sway-sig
spec:
  params:
    - name: s3-credentials
      type: string
      description: name of the s3 secret credentials
      default: sway-sig-v2
    - name: FEDORA_VERSION
      type: string
      description: The version of fedora.
  workspaces:
    - name: target
  steps:
    - name: move-s3-to-tmp
      image: docker.io/peakcom/s5cmd:latest@sha256:05e98772fe01d924b144978b8eb91b365e8bf919038c517bc19fd2dffc8c4e12
      args:
        - --endpoint-url
        - http://rook-ceph-rgw-slow-ceph-objectstore.rook-ceph.svc.cluster.local
        - mv
        - s3://sway-sig/iso/Fedora-Sway-Live-$(params.FEDORA_VERSION)*
        - $(workspaces.target.path)/iso/tmp/
      env:
        - name: AWS_ACCESS_KEY_ID
          valueFrom:
            secretKeyRef:
              name: $(params.s3-credentials)
              key: AWS_ACCESS_KEY_ID
        - name: AWS_SECRET_ACCESS_KEY
          valueFrom:
            secretKeyRef:
              name: $(params.s3-credentials)
              key: AWS_SECRET_ACCESS_KEY
    - name: move-tmp-to-prod
      image: bash@sha256:e0acf0b8fb59c01b6a2b66de360c86bcad5c3cd114db325155970e6bab9663a0
      script: |
        #!/usr/bin/env bash
        mv $(workspaces.target.path)/iso/tmp/Fedora-Sway-Live-$(params.FEDORA_VERSION)* $(workspaces.target.path)/iso
