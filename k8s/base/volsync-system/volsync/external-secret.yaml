---
apiVersion: external-secrets.io/v1
kind: ClusterExternalSecret
metadata:
  name: volsync-kopia
spec:
  externalSecretName: volsync-kopia
  namespaceSelectors:
    - matchLabels:
        volsync.kutara.io/enabled: "true"
  externalSecretSpec:
    refreshInterval: 1h
    secretStoreRef:
      name: bitwarden
      kind: ClusterSecretStore
    target:
      name: volsync-kopia
      creationPolicy: Owner
      template:
        type: Opaque
        data:
          # Kopia repository configuration
          KOPIA_REPOSITORY: "sftp://{{ .rsyncNetHost }}/data1/home/{{ .rsyncNetUser }}/volsync"
          KOPIA_PASSWORD: "{{ .kopiaPassword }}"
          # SFTP backend configuration for rsync.net
          SFTP_HOST: "{{ .rsyncNetHost }}"
          SFTP_PORT: "22"
          SFTP_USERNAME: "{{ .rsyncNetUser }}"
          SFTP_PASSWORD: "{{ .rsyncNetPass }}"
          SFTP_PATH: "/data1/home/{{ .rsyncNetUser }}/volsync"
          SFTP_KNOWN_HOSTS_DATA: "{{ .rsyncNetKnownHosts }}"
    data:
      - secretKey: kopiaPassword
        remoteRef:
          key: kopiaPassword
      - secretKey: rsyncNetHost
        remoteRef:
          key: rsyncNetHost
      - secretKey: rsyncNetUser
        remoteRef:
          key: rsyncNetUser
      - secretKey: rsyncNetPass
        remoteRef:
          key: rsyncNetPass
      - secretKey: rsyncNetKnownHosts
        remoteRef:
          key: rsyncNetKnownHosts
