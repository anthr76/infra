---
variant: fcos
version: 1.3.0
passwd:
  users:
    - name: kubic
      ssh_authorized_keys:
        - ${ssh_authorized_key}
storage:
  filesystems:
    - device: /dev/disk/by-label/ROOT
      format: btrfs
      path: /home
      wipe_filesystem: false
      mount_options:
        - subvol=/@/home
  files:
    - path: /etc/hostname
      mode: 0644
      contents:
        inline:
          ${domain_name}
    - path: /opt/bootstrap/layout
      mode: 0544
      contents:
        inline: |
          #!/bin/bash -e
          mkdir -p -- auth tls/etcd tls/k8s
          awk '/#####/ {filename=$2; next} {print > filename}' assets
          mkdir -p /etc/kubernetes/pki/etcd
          mv tls/etcd/* /etc/kubernetes/pki/
          mv auth/* /etc/kubernetes/pki/
          mv tls/k8s/* /etc/kubernetes/pki/
          rm -rf assets auth static-manifests tls manifests-networking
    - path: /etc/transactional-update.conf
      mode: 0644
      overwrite: true
      contents:
        inline: REBOOT_METHOD=kured
    - path: /etc/sudoers.d/kubic
      overwrite: true
      contents:
        inline: "kubic ALL=(ALL) NOPASSWD: ALL"
    - path: /etc/sysctl.d/max-user-watches.conf
      contents:
        inline: |
          fs.inotify.max_user_watches=16184
    - path: /etc/sysctl.d/reverse-path-filter.conf
      contents:
        inline: |
          net.ipv4.conf.default.rp_filter=0
          net.ipv4.conf.*.rp_filter=0
    - path: /etc/systemd/system.conf.d/accounting.conf
      contents:
        inline: |
          [Manager]
          DefaultCPUAccounting=yes
          DefaultMemoryAccounting=yes
          DefaultBlockIOAccounting=yes
    - path: /var/lib/firstboot.sh
      overwrite: true
      mode: 0493
      contents:
        inline: |
          systemctl stop sshd.service
          transactional-update --continue run bash -c '
            #!/usr/bin/env bash
            zypper --non-interactive addrepo https://download.opensuse.org/repositories/home:anthr76:kubernetes/openSUSE_Tumbleweed/home:anthr76:kubernetes.repo
            zypper --non-interactive --gpg-auto-import-keys refresh
            zypper --non-interactive --gpg-auto-import-keys dup
            zypper --non-interactive --gpg-auto-import-keys install open-iscsi inotify-tools terminfo podman
            systemctl enable iscsid
            /usr/bin/echo iscsi_tcp > /etc/modules-load.d/iscsi-tcp.conf
            /usr/bin/kubeadm config images pull
          '
    - path: /etc/crio/crio.conf.d/05-kutara.conf
      overwrite: true
      contents:
        inline: |
          [crio]
          storage_driver = "btrfs"
          [crio.runtime.runtimes.runc]
          allowed_annotations = [
          "io.containers.trace-syscall",
          "io.kubernetes.cri-o.userns-mode",
          "io.kubernetes.cri-o.Devices",
          ]
          [crio.metrics]
          enable_metrics = true
          metrics_port = 9090
systemd:
  units:
    - name: issuegen-first-boot.service
      enabled: true
      contents: |
        [Unit]
        Description=Inital first boot packages
        Before=issue-generator.service kubelet.service
        Conflicts=shutdown.target
        DefaultDependencies=no
        After=network-online.target wicked.service wickedd.service
        ConditionPathIsReadWrite=/etc
        ConditionPathExists=!/var/lib/issuegen-first-boot

        [Service]
        Type=oneshot
        ExecStart=/usr/bin/bash /var/lib/firstboot.sh
        ExecStartPost=/usr/bin/touch /var/lib/issuegen-first-boot
        ExecStartPost=/usr/bin/systemctl --no-block reboot
        RemainAfterExit=yes

        [Install]
        WantedBy=issue-generator.service
