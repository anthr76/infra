include:
- template: Security/Secret-Detection.gitlab-ci.yml
- template: Security/License-Scanning.gitlab-ci.yml
- template: Terraform.latest.gitlab-ci.yml

# Rewrite Stages

license_scanning:
  stage: ğŸ’¨ smoke test
  script:
    - /run.sh analyze .

.secret-analyzer:
  stage: ğŸ’¨ smoke test

.init: &init
  stage: ğŸ› ï¸ prep
  only:
    changes:
      - ${TF_ROOT}/**/*
  parallel:
    matrix:
      - TF_ROOT: ["clusters/nyc1/iac"]

.validate: &validate
  stage: ğŸ’¨ smoke test
  only:
    changes:
      - ${TF_ROOT}/**/*
  parallel:
    matrix:
      - TF_ROOT: ["clusters/nyc1/iac"]

.build: &build
  stage: ğŸ‘€ plan
  only:
    changes:
      - ${TERRAFORM_DIRECTORY}/**/*
  parallel:
    matrix:
      - TF_ROOT: ["clusters/nyc1/iac"]

.deploy: &deploy
  stage: ğŸš€ deploy

stages:
  - ğŸ’¨ smoke test
  - ğŸ› ï¸ prep
  - ğŸ‘€ plan
  - ğŸš€ deploy