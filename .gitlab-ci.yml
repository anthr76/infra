include:
- template: Security/Secret-Detection.gitlab-ci.yml
- template: Security/License-Scanning.gitlab-ci.yml
- template: Terraform.latest.gitlab-ci.yml

# Rewrite Stages

license_scanning:
  stage: üí® smoke test
  script:
    - /run.sh analyze .

.secret-analyzer:
  stage: üí® smoke test

.init: &init
  stage: üõ†Ô∏è prep
  only:
    changes:
      - clusters/nyc1/iac/**/*
    refs:
      - branches
      - merge_requests
  parallel:
    matrix:
      - TF_ROOT: ["clusters/nyc1/iac"]

.validate: &validate
  stage: üí® smoke test
  only:
    changes:
      - clusters/nyc1/iac/**/*
    variables:
      - $CI_COMMIT_REF_PROTECTED
    refs:
      - branches
      - merge_requests
  before_script:
    - echo ${TEST} > this
    - cat this
    - apk add --no-cache curl gnupg
    - curl -qsL https://github.com/mozilla/sops/releases/download/v3.7.1/sops-v3.7.1.linux -o /usr/local/bin/sops
    - chmod +x /usr/local/bin/sops
    - gpg --import ${SOPS_SYSTEM_KEY}
  parallel:
    matrix:
      - TF_ROOT: ["clusters/nyc1/iac"]

.build: &build
  stage: üëÄ plan
  only:
    changes:
      - clusters/nyc1/iac/**/*
    refs:
      - merge_requests
    variables:
      - $CI_COMMIT_REF_PROTECTED
  before_script:
    - echo ${TEST}
    - apk add --no-cache curl gnupg
    - curl -qsL https://github.com/mozilla/sops/releases/download/v3.7.1/sops-v3.7.1.linux -o /usr/local/bin/sops
    - chmod +x /usr/local/bin/sops
    - gpg --import ${SOPS_SYSTEM_KEY}
  parallel:
    matrix:
      - TF_ROOT: ["clusters/nyc1/iac"]

.deploy: &deploy
  only:
    variables:
      - $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
    changes:
      - clusters/nyc1/iac/**/*
  stage: üöÄ deploy
  before_script:
    - echo ${TEST}
    - apk add --no-cache curl gnupg
    - curl -qsL https://github.com/mozilla/sops/releases/download/v3.7.1/sops-v3.7.1.linux -o /usr/local/bin/sops
    - chmod +x /usr/local/bin/sops
    - gpg --import ${SOPS_SYSTEM_KEY}
  parallel:
    matrix:
      - TF_ROOT: ["clusters/nyc1/iac"]

stages:
  - üí® smoke test
  - üõ†Ô∏è prep
  - üëÄ plan
  - üöÄ deploy
