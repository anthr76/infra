---

- name: set facts for ansible ssh
  set_fact:
    ansible_connection: ssh
    ansible_user: vyos

- name: copy coredns corefile
  ansible.builtin.copy:
    src: Corefile
    dest: /config/user-data/Corefile
    owner: root
    group: vyattacfg
    mode: '0775'
  become: true

- name: start coredns
  containers.podman.podman_container:
    name: coredns
    image: docker.io/coredns/coredns:1.8.3
    state: started
    restart_policy: always
    network: host
    command:
      - -conf
      - /etc/Corefile
    volume:
      - /etc/hosts:/etc/hosts:ro
      - /config/user-data/Corefile:/etc/Corefile
  become: true
  register: podman_run

- name: copy hack for unstable podman CLI
  ansible.builtin.copy:
    src: postconfig-bootup.sh
    dest: /config/scripts/vyos-postconfig-bootup.script
    owner: root
    group: vyattacfg
    mode: '0775'
  become: true

- name: set facts for network connection
  set_fact:
    ansible_connection: ansible.netcommon.network_cli
    ansible_network_os: vyos.vyos.vyos
    ansible_user: vyos
